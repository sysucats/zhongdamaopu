<!-- ç–«è‹—ä¿¡æ¯ç®¡ç† -->
<view class="vaccine-section" wx:if="{{selectedCat}}">
  <!-- ç–«è‹—åˆ—è¡¨ -->
  <view class="vaccine-list" wx:if="{{vaccineList && vaccineList.length > 0}}">
    <view class="vaccine-item" wx:for="{{vaccineList}}" wx:key="_id">
      <!-- å†…å®¹ -->
      <view class="vaccine-content" style="transform: translateX({{item.offsetX || 0}}rpx)"
            catch:touchstart="touchStart" catch:touchmove="touchMove" catch:touchend="touchEnd"
            data-id="{{item._id}}" data-index="{{index}}">
        <view class="vaccine-header">
          <view class="vaccine-type">{{item.vaccine_type}}</view>
          <view class="vaccine-date">{{item.vaccine_date_formatted}}</view>
        </view>
        <view class="vaccine-body">
          <view class="vaccine-location" wx:if="{{item.location}}">æ¥ç§åœ°ç‚¹ï¼š{{item.location}}</view>
          <view class="vaccine-expire" wx:if="{{item.expire_date_formatted}}">æœ‰æ•ˆæœŸè‡³ï¼š{{item.expire_date_formatted}}</view>
          <view class="vaccine-next" wx:if="{{item.next_vaccine_date_formatted}}">ä¸‹æ¬¡æ¥ç§ï¼š{{item.next_vaccine_date_formatted}}</view>
          <view class="vaccine-remarks" wx:if="{{item.remarks}}">å¤‡æ³¨ï¼š{{item.remarks}}</view>
        </view>
        <view class="item-indicator"></view>
      </view>
      
      <!-- æ»‘åŠ¨æ“ä½œ -->
      <view class="swipe-actions">
        <view class="action-edit" catchtap="editVaccine" data-id="{{item._id}}">ç¼–è¾‘</view>
        <view class="action-delete" catchtap="deleteVaccine" data-id="{{item._id}}">åˆ é™¤</view>
      </view>
    </view>
  </view>
  
  <view class="empty-tip" wx:else>
    <view class="empty-icon">ğŸ“‹</view>
    <view>æš‚æ— ç–«è‹—è®°å½•ï¼Œç‚¹å‡»å³ä¸‹è§’æ·»åŠ </view>
  </view>
</view>

<!-- ç–«è‹—è¡¨å• -->
<popup show="{{showVaccineModal}}" position="center" zindex="1000" bind:close="cancelVaccine">
  <view class="modal-content-wrapper">
    <view class="modal-header">
      <text>{{isEditingVaccine ? 'ç¼–è¾‘ç–«è‹—è®°å½•' : 'æ·»åŠ ç–«è‹—è®°å½•'}}</text>
      <view class="modal-close" bindtap="cancelVaccine">Ã—</view>
    </view>
    <view class="modal-body">
      <form bindsubmit="saveVaccine">
        <view class="form-item">
          <view class="form-label">ç–«è‹—ç±»å‹</view>
          <picker bindchange="vaccineTypeChange" value="{{selectedTypeIndex}}" range="{{vaccineTypes}}">
            <view class="picker">{{vaccineForm.vaccine_type || 'è¯·é€‰æ‹©ç–«è‹—ç±»å‹'}}</view>
          </picker>
          <view class="custom-type-option" bindtap="toggleCustomType">
            <text>{{useCustomType ? 'é€‰æ‹©é¢„è®¾ç±»å‹' : 'ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹'}}</text>
          </view>
          <input wx:if="{{useCustomType}}" class="custom-type-input" type="text" 
                 placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰ç–«è‹—ç±»å‹" 
                 bindinput="customTypeInput" 
                 value="{{vaccineForm.custom_vaccine_type}}"></input>
        </view>
        <view class="form-item">
          <view class="form-label">æ¥ç§æ—¥æœŸ</view>
          <picker mode="date" bindchange="vaccineDateChange" value="{{vaccineForm.vaccine_date}}">
            <view class="picker">{{vaccineForm.vaccine_date_formatted || 'è¯·é€‰æ‹©æ¥ç§æ—¥æœŸ'}}</view>
          </picker>
        </view>
        <view class="form-item">
          <view class="form-label">æœ‰æ•ˆæœŸè‡³</view>
          <picker mode="date" bindchange="expireDateChange" value="{{vaccineForm.expire_date}}">
            <view class="picker">{{vaccineForm.expire_date_formatted || 'è¯·é€‰æ‹©æœ‰æ•ˆæœŸ'}}</view>
          </picker>
        </view>
        <view class="form-item">
          <view class="form-label">ä¸‹æ¬¡æ¥ç§æ—¥æœŸ</view>
          <picker mode="date" bindchange="nextDateChange" value="{{vaccineForm.next_vaccine_date}}">
            <view class="picker">{{vaccineForm.next_vaccine_date_formatted || 'è¯·é€‰æ‹©ä¸‹æ¬¡æ¥ç§æ—¥æœŸ'}}</view>
          </picker>
        </view>
        <view class="form-item">
          <view class="form-label">æ¥ç§åœ°ç‚¹</view>
          <input class="location-input" type="text" name="location" placeholder="è¯·è¾“å…¥æ¥ç§åœ°ç‚¹" value="{{vaccineForm.location}}"></input>
        </view>
        <view class="form-item">
          <view class="form-label">å¤‡æ³¨</view>
          <textarea class="remarks-input" name="remarks" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¦‚ï¼šè¯ç‰©å“ç‰Œã€å‰‚é‡ã€æ³¨æ„äº‹é¡¹ç­‰ï¼‰" value="{{vaccineForm.remarks}}"></textarea>
        </view>
        <view class="form-buttons">
          <button class="cancel-btn" bindtap="cancelVaccine">å–æ¶ˆ</button>
          <button class="submit-btn" form-type="submit">ä¿å­˜</button>
        </view>
      </form>
    </view>
  </view>
</popup>

<!-- ç–«è‹—ç±»å‹ç®¡ç† -->
<popup show="{{showTypeManageModal}}" position="center" zindex="1000" bind:close="cancelTypeManage">
  <view class="modal-content-wrapper">
    <view class="modal-header">
      <text>ç¼–è¾‘ç–«è‹—ç±»å‹</text>
      <view class="modal-close" bindtap="cancelTypeManage">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="type-add-form">
        <input type="text" placeholder="è¾“å…¥æ–°ç–«è‹—åç§°" bindinput="onNewTypeInput" value="{{newVaccineType}}"></input>
        <button class="add-type-btn" bindtap="addVaccineType">æ·»åŠ </button>
      </view>
      <view class="type-list">
        <view class="type-item" wx:for="{{vaccineTypes}}" wx:key="*this">
          <text class="type-name">{{item}}</text>
          <view class="type-delete" catchtap="deleteVaccineType" data-type="{{item}}">Ã—</view>
        </view>
        <view class="empty-tip" wx:if="{{!vaccineTypes || vaccineTypes.length === 0}}">æš‚æ— ç–«è‹—</view>
      </view>
      <view class="type-tips">æç¤ºï¼šå·²ç»è¢«ä½¿ç”¨çš„ç–«è‹—æ— æ³•åˆ é™¤</view>
      <view class="form-buttons">
        <button class="cancel-btn" bindtap="cancelTypeManage">å…³é—­</button>
      </view>
    </view>
  </view>
</popup>

<!-- å·²æ¥ç§çŒ«å’ªåˆ—è¡¨ -->
<popup show="{{showVaccinatedCatsModal}}" position="center" zindex="1000" bind:close="closeVaccinatedCatsModal">
  <view class="modal-content-wrapper">
    <view class="modal-header">
      <text>å·²æ¥ç§ç–«è‹—çš„çŒ«çŒ«</text>
      <view class="modal-close" bindtap="closeVaccinatedCatsModal">Ã—</view>
    </view>
    <view class="modal-body">
      <!-- ç–«è‹—ç±»å‹ç­›é€‰ -->
      <view class="vaccine-type-filter">
        <view class="filter-options">
          <view class="filter-option {{selectedVaccineType === '' ? 'active' : ''}}" 
                bindtap="selectVaccineTypeFilter" data-type="">å…¨éƒ¨</view>
          <view class="filter-option {{selectedVaccineType === item ? 'active' : ''}}" 
                wx:for="{{vaccineTypes}}" wx:key="*this"
                bindtap="selectVaccineTypeFilter" data-type="{{item}}">{{item}}</view>
        </view>
      </view>
      
      <!-- çŒ«å’ªåˆ—è¡¨ -->
      <view class="vaccinated-cats-list">
        <view class="cat-item" wx:for="{{vaccinatedCats}}" wx:key="_id" bindtap="viewCatDetail" data-cat-id="{{item._id}}">
          <image class="cat-avatar" mode="aspectFill" src="{{item.avatar.photo_compressed || item.avatar.photo_id}}"></image>
          <view class="cat-info">
            <view class="cat-name">{{item.name}}</view>
            <view class="cat-details">{{item.campus}} {{item.area}}</view>
            <view class="vaccine-info" wx:if="{{item.last_vaccine}}">
              <text>æœ€è¿‘æ¥ç§: {{item.last_vaccine.vaccine_type}} ({{item.last_vaccine.vaccine_date_formatted}})</text>
            </view>
          </view>
        </view>
        <view class="empty-tip" wx:if="{{!vaccinatedCats || vaccinatedCats.length === 0}}">
          <view class="empty-icon">ğŸ±</view>
          <view>æš‚æ— å·²æ¥ç§ç–«è‹—çš„çŒ«å’ª</view>
        </view>
      </view>
      
      <view class="form-buttons">
        <button class="cancel-btn" bindtap="closeVaccinatedCatsModal">å…³é—­</button>
      </view>
    </view>
  </view>
</popup> 