<wxs module="filter" src="../../../utils/filter.wxs"></wxs>

<view class="container">
  <!-- æƒé™æ£€æŸ¥ -->
  <block wx:if="{{!auth}}">
    <view class="loading-container">
      <text>æ£€æŸ¥æƒé™ä¸­...</text>
    </view>
  </block>

  <block wx:else>
    <!-- åŠ è½½çŠ¶æ€ -->
    <block wx:if="{{loading}}">
      <view class="loading-container">
        <text>åŠ è½½ä¸­...</text>
      </view>
    </block>

    <block wx:else>
      <!-- é¦–é¡µå¯¼èˆªæ  -->
      <block wx:if="{{currentLevel === 'cats'}}">
        <view class="photo-header">
          <view class="header-content">
            <!-- æœç´¢æ¡† -->
            <view class="search-box">
              <input 
                class="search-input" 
                placeholder="æœç´¢çŒ«çŒ«åå­—..." 
                value="{{searchKeyword}}"
                bindinput="onSearchInput"
              />
              <block wx:if="{{searchKeyword}}">
                <view class="search-clear" bindtap="clearSearch">
                  <text class="clear-icon">Ã—</text>
                </view>
              </block>
              <view class="search-icon">ğŸ”</view>
            </view>
            <view class="header-actions">
              <view class="action-btn" bindtap="refreshCats">
                <text class="action-icon">ğŸ”„</text>
              </view>
            </view>
          </view>
        </view>
      </block>

      <!-- é¦–é¡µç»Ÿè®¡å¡ç‰‡ -->
      <block wx:if="{{currentLevel === 'cats'}}">
        <view class="stats-section">
          <view class="stats-grid">
            <view class="stat-card card1">
              <view class="stat-value">{{stats.totalCats}}</view>
              <view class="stat-label">çŒ«çŒ«æ•°é‡</view>
            </view>
            <view class="stat-card card2">
              <view class="stat-value">{{stats.totalPhotos || 0}}</view>
              <view class="stat-label">æ€»ç…§ç‰‡æ•°</view>
            </view>
            <view class="stat-card card3">
              <view class="stat-value">{{stats.currentUserPhotos || 0}}</view>
              <view class="stat-label">æˆ‘çš„ä¸Šä¼ </view>
            </view>
          </view>
        </view>

        <!-- ä½ç½®ç­›é€‰æ  -->
        <view class="filter-section">
          <view class="filter-group">
            <view class="campus-scroll-container">
              <scroll-view class="campus-scroll" scroll-x="true">
                <view class="campus-list">
                  <view 
                    class="campus-tag {{filterCampus === 'all' ? 'active' : ''}}"
                    bindtap="selectCampusFilter"
                    data-campus="all"
                  >
                    <text class="campus-name">å…¨éƒ¨ä½ç½®</text>
                    <text class="campus-count">{{stats.totalCats}}</text>
                  </view>
                  <block wx:for="{{campuses}}" wx:key="name">
                    <view 
                      class="campus-tag {{filterCampus === item.name ? 'active' : ''}}"
                      bindtap="selectCampusFilter"
                      data-campus="{{item.name}}"
                    >
                      <text class="campus-name">{{item.name}}</text>
                      <text class="campus-count">{{item.count}}</text>
                    </view>
                  </block>
                </view>
              </scroll-view>
            </view>
          </view>
        </view>
      </block>

      <!-- å†…å®¹åŒºåŸŸ -->
      <view class="content-area {{currentLevel === 'cats' ? 'cats-content' : ''}}">
        <!-- çŒ«çŒ«åˆ—è¡¨ - ä¸‰åˆ—å¸ƒå±€ -->
        <block wx:if="{{currentLevel === 'cats'}}">
          <scroll-view 
            class="cats-scroll-view" 
            scroll-y="true" 
            bindscrolltolower="loadMoreCats"
            lower-threshold="100"
          >
            <view class="cats-grid">
              <block wx:for="{{filteredCats}}" wx:key="_id">
                <view class="cat-item" bindtap="selectCat" data-cat-id="{{item._id}}">
                  <image class="cat-avatar" src="{{item.avatar}}" mode="aspectFill" />
                  <view class="cat-info">
                    <view class="cat-name">{{item.displayName}}</view>
                    <block wx:if="{{item.campus}}">
                      <view class="cat-campus">
                        <text class="campus-badge">{{item.campus}}</text>
                      </view>
                    </block>
                    <view class="cat-stats">
                      <text class="photo-count">{{item.photo_count_total || 0}}</text>
                      <block wx:if="{{item.photo_count_best > 0}}">
                        <text class="best-count">{{item.photo_count_best}}ç²¾é€‰</text>
                      </block>
                    </view>
                  </view>
                </view>
              </block>
            </view>
            
            <!-- åŠ è½½æ›´å¤šæç¤º -->
            <block wx:if="{{loadingMore}}">
              <view class="loading-more">
                <text>åŠ è½½æ›´å¤šä¸­...</text>
              </view>
            </block>
            
            <!-- æ²¡æœ‰æ›´å¤šæ•°æ®æç¤º -->
            <block wx:if="{{!hasMore && cats.length > 0}}">
              <view class="no-more">
                <text>æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
              </view>
            </block>
          </scroll-view>

          <!-- ç©ºçŠ¶æ€ -->
          <block wx:if="{{filteredCats.length === 0}}">
            <view class="empty-state">
              <view class="empty-icon">ğŸ±</view>
              <view class="empty-text">
                <block wx:if="{{searchKeyword}}">æ²¡æœ‰æ‰¾åˆ°"{{searchKeyword}}"ç›¸å…³çš„çŒ«çŒ«</block>
                <block wx:else>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„çŒ«çŒ«</block>
              </view>
              <view class="empty-subtext">å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–ä½ç½®ç­›é€‰</view>
            </view>
          </block>
        </block>

        <!-- ç…§ç‰‡åˆ—è¡¨ -->
        <block wx:if="{{currentLevel === 'photos'}}">
          <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
          <view class="photo-header">
            <view class="header-content">
              <view class="back-btn" bindtap="goBack">
                <text class="back-icon">â†</text>
                <text class="back-text">è¿”å›</text>
              </view>
              <view class="header-title">
                <text class="cat-name">{{selectedCat.displayName}}</text>
                <text class="photo-count">({{currentCatPhotos.length}}å¼ )</text>
              </view>
              <view class="header-actions">
                <view class="action-btn" bindtap="reloadCurrentCatData">
                  <text class="action-icon">ğŸ”„</text>
                </view>
                <view class="action-btn" bindtap="toggleEditMode">
                  <text class="action-icon">{{editMode ? 'âŒ' : 'âœï¸'}}</text>
                </view>
              </view>
            </view>
          </view>

          <!-- ç­›é€‰æ  -->
          <view class="filter-section">
            <!-- ä¸Šä¼ è€…ç­›é€‰ -->
            <view class="filter-group" wx:if="{{uploaders.length > 0}}">
              <view class="uploader-scroll-container">
                <scroll-view class="uploader-scroll" scroll-x="true">
                  <view class="uploader-list">
                    <block wx:for="{{uploaders}}" wx:key="_id">
                      <view 
                        class="uploader-tag {{filterUploader === item._id ? 'active' : ''}}"
                        bindtap="selectUploaderFilter"
                        data-uploader-id="{{item._id}}"
                      >
                        <image class="uploader-avatar" src="{{item.avatar}}" mode="aspectFill" />
                        <text class="uploader-name">{{item.nickname}}</text>
                        <text class="uploader-count">{{item.totalPhotos}}</text>
                      </view>
                    </block>
                  </view>
                </scroll-view>
              </view>
            </view>

            <!-- ç²¾é€‰ç­›é€‰ -->
            <view class="filter-group">
              <view class="best-filter">
                <view 
                  class="filter-tab {{!filterBest ? 'active' : ''}}"
                  bindtap="toggleBestFilter"
                >
                  <text class="filter-icon">ğŸ“·</text>
                  <text class="filter-text">å…¨éƒ¨</text>
                  <text class="filter-text">{{currentCatPhotos.length}}</text>
                </view>
                <view 
                  class="filter-tab {{filterBest ? 'active' : ''}}"
                  bindtap="toggleBestFilter"
                >
                  <text class="filter-icon">â­</text>
                  <text class="filter-text">ç²¾é€‰</text>
                  <text class="filter-text">{{bestCount}}</text>
                </view>
              </view>
            </view>
          </view>

          <!-- ç…§ç‰‡ç½‘æ ¼ -->
          <view class="photos-container">
            <view class="photos-grid {{editMode ? 'edit-mode' : ''}}">
              <block wx:for="{{photos}}" wx:key="_id">
                <view 
                  class="photo-item {{(filter.indexOf(selectedPhotos, item._id)) > -1 ? 'selected' : ''}}"
                  bindtap="{{editMode ? 'togglePhotoSelection' : 'previewPhoto'}}"
                  data-photo-id="{{item._id}}"
                  bindlongpress="toggleEditMode"
                >

                  <image 
                    class="photo-image" 
                    src="{{item.photo_compressed || item.photo_watermark}}" 
                    mode="aspectFill" 
                    lazy-load="true"
                  />
                  
                  <!-- ç²¾é€‰æ ‡è¯† -->
                  <block wx:if="{{item.best}}">
                    <view class="photo-badge">â­</view>
                  </block>

                  <!-- é€‰æ‹©æ¡† -->
                  <block wx:if="{{editMode}}">
                    <view class="photo-checkbox">
                      <block wx:if="{{(filter.indexOf(selectedPhotos, item._id)) > -1}}">âœ”</block>
                    </view>
                  </block>
                </view>
              </block>
            </view>

            <!-- ç©ºçŠ¶æ€ -->
            <block wx:if="{{photos.length === 0}}">
              <view class="empty-state">
                <view class="empty-icon">
                  <block wx:if="{{currentCatPhotos.length === 0}}">ğŸ“¸</block>
                  <block wx:else>ğŸ”</block>
                </view>
                <view class="empty-text">
                  <block wx:if="{{currentCatPhotos.length === 0}}">è¯¥çŒ«çŒ«è¿˜æ²¡æœ‰ç…§ç‰‡</block>
                  <block wx:else>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç…§ç‰‡</block>
                </view>
                <view class="empty-subtext">
                  <block wx:if="{{currentCatPhotos.length === 0}}">
                    è¿˜æ²¡æœ‰äººä¸º {{selectedCat.displayName}} ä¸Šä¼ è¿‡ç…§ç‰‡
                  </block>
                  <block wx:else>
                    å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶
                  </block>
                </view>
              </view>
            </block>
          </view>
        </block>
      </view>

      <!-- ç¼–è¾‘æ¨¡å¼æ“ä½œæ  -->
      <block wx:if="{{editMode && currentLevel === 'photos'}}">
        <view class="action-bar">
          <view class="action-info">
            å·²é€‰æ‹© {{selectedPhotos.length}} å¼ ç…§ç‰‡
          </view>
          <view class="action-buttons">
            <button 
              class="action-btn primary" 
              bindtap="showSetBestConfirm"
              disabled="{{selectedPhotos.length === 0}}"
            >
              è®¾ä¸ºç²¾é€‰
            </button>
            <button 
              class="action-btn secondary" 
              bindtap="showCancelBestConfirm"
              disabled="{{selectedPhotos.length === 0}}"
            >
              å–æ¶ˆç²¾é€‰
            </button>
            <button 
              class="action-btn danger" 
              bindtap="showDeleteConfirm"
              disabled="{{selectedPhotos.length === 0}}"
            >
              åˆ é™¤
            </button>
          </view>
        </view>
      </block>
    </block>
  </block>

  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <block wx:if="{{showDeleteConfirm}}">
    <view class="modal-mask" bindtap="hideDeleteConfirm">
      <view class="modal-content" catchtap="stopPropagation">
        <view class="modal-title">ç¡®è®¤åˆ é™¤</view>
        <view class="modal-message">ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„{{selectedPhotos.length}}å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</view>
        <view class="modal-actions">
          <button class="modal-btn cancel" bindtap="hideDeleteConfirm">å–æ¶ˆ</button>
          <button class="modal-btn confirm" bindtap="confirmBatchDelete">åˆ é™¤</button>
        </view>
      </view>
    </view>
  </block>

  <!-- è®¾ä¸ºç²¾é€‰ç¡®è®¤å¼¹çª— -->
  <block wx:if="{{showSetBestConfirm}}">
    <view class="modal-mask" bindtap="hideSetBestConfirm">
      <view class="modal-content" catchtap="stopPropagation">
        <view class="modal-title">è®¾ä¸ºç²¾é€‰</view>
        <view class="modal-message">ç¡®å®šè¦å°†é€‰ä¸­çš„{{selectedPhotos.length}}å¼ ç…§ç‰‡è®¾ä¸ºç²¾é€‰å—ï¼Ÿ</view>
        <view class="modal-actions">
          <button class="modal-btn cancel" bindtap="hideSetBestConfirm">å–æ¶ˆ</button>
          <button class="modal-btn confirm" bindtap="confirmBatchSetBest">ç¡®å®š</button>
        </view>
      </view>
    </view>
  </block>

  <!-- å–æ¶ˆç²¾é€‰ç¡®è®¤å¼¹çª— -->
  <block wx:if="{{showCancelBestConfirm}}">
    <view class="modal-mask" bindtap="hideCancelBestConfirm">
      <view class="modal-content" catchtap="stopPropagation">
        <view class="modal-title">å–æ¶ˆç²¾é€‰</view>
        <view class="modal-message">ç¡®å®šè¦å–æ¶ˆé€‰ä¸­çš„{{selectedPhotos.length}}å¼ ç…§ç‰‡çš„ç²¾é€‰çŠ¶æ€å—ï¼Ÿ</view>
        <view class="modal-actions">
          <button class="modal-btn cancel" bindtap="hideCancelBestConfirm">å–æ¶ˆ</button>
          <button class="modal-btn confirm" bindtap="confirmBatchCancelBest">ç¡®å®š</button>
        </view>
      </view>
    </view>
  </block>
</view>
