<!--pages/manage/catManage/catManage.wxml-->
<view class="container" wx:if="{{auth}}">
  <!-- æœç´¢çŒ«å’ª -->
  <view class="search-box">
    <view class='input-block'>
      <image class="search-logo" mode='aspectFit' src="/pages/public/images/filter/search.png"></image>
      <input class='search-input' placeholder='{{text_cfg.genealogy.search_tip}}' bindinput="onSearchInput" confirm-type='search' bindconfirm="searchCat"></input>
    </view>
  </view>

  <!-- é€‰é¡¹å¡åˆ‡æ¢ -->
  <view class="tabs">
    <view class="tab {{activeTab === 'info' ? 'active' : ''}}" bindtap="switchTab" data-tab="info">
      <text class="iconfont icon-edit"></text>
      <text class="tab-text">ä¿¡æ¯</text>
    </view>
    <view class="tab {{activeTab === 'relation' ? 'active' : ''}}" bindtap="switchTab" data-tab="relation">
      <text class="iconfont icon-relation"></text>
      <text class="tab-text">å…³ç³»</text>
    </view>
    <view class="tab {{activeTab === 'vaccine' ? 'active' : ''}}" bindtap="switchTab" data-tab="vaccine">
      <text class="iconfont icon-vaccine"></text>
      <text class="tab-text">ç–«è‹—</text>
    </view>
  </view>

  <!-- é€‰ä¸­çš„çŒ«å’ªä¿¡æ¯ -->
  <view class="selected-cat" wx:if="{{selectedCat}}" bindtap="navigateToCat" data-cat="{{selectedCat}}">
    <image class="cat-avatar" mode="aspectFill" src="{{selectedCat.avatar.photo_compressed || selectedCat.avatar.photo_id}}"></image>
    <view class="cat-info">
      <view class="cat-name">{{selectedCat.name}}</view>
      <view class="cat-details">{{selectedCat.campus}} {{selectedCat.area}}</view>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content" wx:if="{{selectedCat || activeTab === 'info' || activeTab === 'vaccine'}}">
    <!-- å…³ç³»ç»„ä»¶ -->
    <relation-tab wx:if="{{activeTab === 'relation'}}" selected-cat="{{selectedCat}}" id="relationTab"></relation-tab>
    
    <!-- ç–«è‹—ç»„ä»¶ - å§‹ç»ˆåŠ è½½ -->
    <vaccine-tab wx:if="{{activeTab === 'vaccine'}}" selected-cat="{{selectedCat}}" id="vaccineTab" bind:selectCat="onVaccineTabSelectCat"></vaccine-tab>
    
    <!-- çŒ«å’ªä¿¡æ¯ç¼–è¾‘ç»„ä»¶ -->
    <cat-info-tab wx:if="{{activeTab === 'info'}}" 
                 selected-cat="{{selectedCat}}" 
                 cat_id="{{selectedCat._id || ''}}" 
                 auth="{{auth}}" 
                 id="catInfoTab"
                 is-new-cat="{{isNewMode && !selectedCat}}"
                 bind:catCreated="onCatCreated" 
                 bind:catUpdated="onCatUpdated" 
                 bind:modeChange="onInfoTabModeChange"></cat-info-tab>
    
    <!-- æµ®åŠ¨æ·»åŠ æŒ‰é’® -->
    <view class="floating-actions">
      <!-- ç–«è‹—ç®¡ç†é€‰é¡¹ (ä»…åœ¨ç–«è‹—é€‰é¡¹å¡æ˜¾ç¤º) -->
      <view class="vaccine-options {{showVaccineOptions ? 'show' : ''}}" wx:if="{{activeTab === 'vaccine'}}">
        <view class="vaccine-option" bindtap="handleVaccineTypeManager" wx:if="{{selectedCat}}">
          <text class="option-text">ç–«è‹—ç±»å‹</text>
          <view class="option-icon iconfont icon-setting-o"></view>
        </view>
        <view class="vaccine-option" bindtap="handleAddVaccine" wx:if="{{selectedCat}}">
          <text class="option-text">æ·»åŠ è®°å½•</text>
          <view class="option-icon iconfont icon-plus"></view>
        </view>
        <view class="vaccine-option" bindtap="handleViewVaccinatedCats">
          <text class="option-text">å·²æ¥ç§</text>
          <view class="option-icon iconfont icon-success"></view>
        </view>
      </view>
      
      <!-- ä¸»æŒ‰é’® -->
      <view class="iconfont {{activeTab === 'info' && (selectedCat || isNewMode) ? 'icon-success' : 'icon-plus'}} action-button {{showVaccineOptions ? 'rotate' : ''}}" 
            bindtap="handleActionButtonClick"></view>
    </view>
  </view>

  <!-- çŒ«å’ªæœç´¢ç»“æœ -->
  <view class="search-results {{(!searchResults || searchResults.length === 0) ? 'empty' : ''}}" wx:if="{{showSearchResults}}">
    <block wx:if="{{searchResults && searchResults.length > 0}}">
      <view class="search-cat" wx:for="{{searchResults}}" wx:key="_id" bindtap="selectCat" data-id="{{item._id}}">
        <image class="search-cat-avatar" mode="aspectFill" src="{{item.avatar.photo_compressed || item.avatar.photo_id}}"></image>
        <view class="search-cat-info">
          <view class="search-cat-name">{{item.name}}</view>
          <view class="search-cat-details">{{item.campus}} {{item.area}}</view>
        </view>
      </view>
    </block>
    <view class="empty-message" wx:else>æœªæ‰¾åˆ°åŒ¹é…çš„çŒ«çŒ«</view>
  </view>

  <!-- æç¤ºä¿¡æ¯ -->
  <view class="tips" wx:if="{{!selectedCat && !isNewMode}}">
    <view class="tip-icon">ğŸ”</view>
    <view class="tip-text">è¯·æœç´¢å¹¶é€‰æ‹©ä¸€åªçŒ«çŒ«è¿›è¡Œç®¡ç†</view>
    <view class="tip-text" wx:if="{{activeTab === 'info'}}">æˆ–ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ æ–°çŒ«</view>
  </view>
</view>

<!-- æœªæˆæƒæç¤º -->
<no-auth wx:else tip-text="{{tipText}}"></no-auth>